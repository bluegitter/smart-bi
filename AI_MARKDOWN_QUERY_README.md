# AI对话框Markdown渲染和数据查询功能

AI对话框现已支持Markdown渲染和真实数据查询功能，让数据分析更加直观和互动。

## ✨ 新功能特色

### 🎨 Markdown渲染支持
- **富文本显示**：AI回复支持完整的Markdown格式
- **代码高亮**：支持SQL、Python、JavaScript等多种语言的语法高亮
- **表格美化**：查询结果以专业的表格形式展示
- **数学公式**：支持KaTeX数学公式渲染
- **复制功能**：代码块支持一键复制

### 📊 实时数据查询
- **工具调用**：AI可以主动查询真实数据集数据
- **SQL执行**：支持SELECT查询语句执行
- **结果展示**：查询结果以Markdown表格形式呈现
- **安全限制**：仅允许查询操作，禁止修改数据

## 🚀 使用方式

### 基础AI问答
用户可以通过Header顶部的AI问答按钮或数据集页面的AI问答入口进行对话：

1. **通用问答模式**：适用于一般性技术咨询
2. **数据集模式**：针对特定数据集的智能分析

### 数据查询示例

#### 用户提问示例：
```
请帮我查看销售数据集中前10条记录
```

#### AI响应示例：
AI会自动构建SQL查询并执行，返回类似如下的Markdown格式结果：

**查询结果：**

| product_name | sales_amount | sale_date | region |
|---|---|---|---|
| iPhone 15 | 15999 | 2024-01-15 | 华北 |
| MacBook Pro | 18999 | 2024-01-16 | 华东 |
| iPad Air | 4999 | 2024-01-17 | 华南 |

**查询统计：**
- 返回行数：10
- 执行时间：45ms
- 执行的SQL：`SELECT product_name, sales_amount, sale_date, region FROM sales_data LIMIT 10`

## 🔧 技术实现

### 组件架构

#### 1. MarkdownRenderer组件
- **位置**：`/src/components/ui/MarkdownRenderer.tsx`
- **功能**：提供完整的Markdown渲染能力
- **特性**：
  - 支持GitHub风格的表格
  - 代码语法高亮
  - 数学公式渲染
  - 自定义样式组件

#### 2. 增强的AIChatDialog
- **位置**：`/src/components/ai/AIChatDialog.tsx`
- **改进**：
  - AI响应自动使用Markdown渲染
  - 用户消息保持纯文本显示
  - 优化的消息气泡样式

#### 3. DataTable组件（备用）
- **位置**：`/src/components/ui/DataTable.tsx`
- **功能**：提供高级表格展示能力
- **特性**：
  - 搜索和过滤
  - 分页显示
  - CSV导出
  - 响应式设计

### API增强

#### 1. dataset-chat API升级
- **工具调用支持**：集成OpenAI工具调用功能
- **queryDataset工具**：AI可主动查询数据
- **安全验证**：SQL注入防护和权限检查

#### 2. 新增dataset-query API
- **端点**：`POST /api/ai/dataset-query`
- **功能**：执行安全的数据集查询
- **限制**：仅支持SELECT语句，最多返回100行

### 支持的LLM提供商

#### 工具调用支持：
- ✅ **OpenAI**：完整支持工具调用
- ✅ **智谱AI**：支持工具调用
- ✅ **月之暗面**：支持工具调用  
- ✅ **DeepSeek**：支持工具调用

#### 普通对话支持：
- ✅ **Anthropic Claude**：Markdown渲染（无工具调用）
- ✅ **其他兼容提供商**：基础功能

## 🎯 使用场景

### 1. 数据探索
```
用户：这个数据集有多少行数据？
AI：让我查询一下数据集的记录总数。

**查询结果：**
| total_rows |
|---|
| 15,847 |

根据查询结果，该数据集共包含15,847条记录。
```

### 2. 统计分析
```
用户：按地区统计销售额
AI：我来为您统计各地区的销售总额。

**查询结果：**
| region | total_sales |
|---|---|
| 华东 | 2,856,789 |
| 华北 | 2,344,567 |
| 华南 | 1,987,432 |

华东地区销售额最高，占总销售额的36.8%。
```

### 3. 数据质量检查
```
用户：检查一下数据中的空值情况
AI：让我检查各字段的空值数量。

**查询结果：**
| column_name | null_count | null_percentage |
|---|---|---|
| product_name | 0 | 0% |
| sales_amount | 23 | 0.15% |
| customer_id | 156 | 0.98% |

数据质量整体良好，customer_id字段有少量空值需要关注。
```

## ⚙️ 配置说明

### 环境变量
确保以下环境变量正确配置：
```env
# LLM配置（至少配置一个支持工具调用的提供商）
OPENAI_API_KEY=your_openai_key
ZHIPU_API_KEY=your_zhipu_key

# 数据库连接
DATABASE_URL=your_database_url
```

### LLM配置
在系统设置中配置至少一个支持工具调用的LLM提供商：
1. 进入「系统设置」→「AI配置」
2. 配置OpenAI或其他支持工具调用的提供商
3. 设置为默认配置

## 🔒 安全特性

### SQL安全防护
- **白名单验证**：仅允许SELECT语句
- **关键词过滤**：禁止DROP、DELETE、UPDATE等危险操作
- **结果限制**：查询结果限制在100行以内
- **权限检查**：验证用户对数据集的访问权限

### 数据保护
- **敏感数据**：不在日志中记录具体查询内容
- **访问控制**：基于用户权限的数据访问
- **超时保护**：查询操作60秒超时限制

## 🎨 样式定制

### Markdown主题
可通过CSS变量自定义Markdown渲染样式：
```css
.markdown-renderer {
  --code-bg: #f8f9fa;
  --code-text: #e83e8c;
  --table-border: #dee2e6;
  --table-header-bg: #f8f9fa;
}
```

### 表格样式
AI查询结果的表格自动应用专业样式：
- 悬浮行高亮
- 边框和间距优化
- 数值右对齐
- 空值特殊显示

## 📊 性能优化

### 查询优化
- **结果缓存**：相同查询结果临时缓存
- **连接池**：数据库连接复用
- **超时控制**：防止长时间查询阻塞

### 渲染优化
- **按需加载**：Markdown组件懒加载
- **虚拟滚动**：大型表格支持虚拟滚动
- **响应式**：移动端自适应显示

## 🚀 未来规划

- [ ] 支持图表生成和数据可视化
- [ ] 查询历史记录和收藏功能
- [ ] 更多数据源类型支持
- [ ] AI生成的查询优化建议
- [ ] 实时数据更新通知
- [ ] 协作式数据分析功能

---

通过这些增强功能，AI对话框不仅能够进行智能问答，还能实时查询和分析真实数据，为用户提供更加直观、准确的数据洞察体验。