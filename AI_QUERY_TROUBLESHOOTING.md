# AI数据查询故障排查指南

## 🔍 问题诊断

当AI返回SQL说明而不是实际执行查询时，可能的原因和解决方案：

## 1. LLM提供商兼容性检查

### ✅ 支持工具调用的提供商
- **OpenAI**: 完全支持，推荐使用
- **智谱AI (GLM)**: 完全支持
- **月之暗面 (Moonshot)**: 完全支持  
- **DeepSeek**: 完全支持

### ❌ 不支持工具调用的提供商
- **Anthropic Claude**: 仅支持Markdown渲染，无法执行查询
- **其他提供商**: 可能不支持工具调用

**解决方案：** 确保在系统设置中配置了支持工具调用的LLM提供商作为默认配置。

## 2. 系统配置检查

### LLM配置验证
```bash
# 检查环境变量
echo $OPENAI_API_KEY
echo $ZHIPU_API_KEY
echo $MOONSHOT_API_KEY
echo $DEEPSEEK_API_KEY
```

### 数据库连接验证
```bash
# 检查数据库环境变量
echo $MYSQL_HOST
echo $MYSQL_DATABASE
echo $MYSQL_USER
```

## 3. 数据集配置检查

### 必需字段验证
确保数据集包含以下信息：
- ✅ `dataSource`: 数据源连接信息
- ✅ `type`: 数据集类型 (table/sql/view)
- ✅ `config`: 根据类型的配置信息
- ✅ `fields`: 字段定义数组

### 数据源连接测试
在数据集详情页面：
1. 点击「测试连接」按钮
2. 确认数据源状态为「已连接」
3. 验证能够正常预览数据

## 4. AI响应模式分析

### 🚫 错误模式（仅提供SQL说明）
```
用户：查看2024年1月的财务数据
AI：为了查看2024年1月的财务收支情况，我需要查询该月份的数据。
假设数据表中...以下是查询语句：
SELECT * FROM finance_data WHERE date_field = '202401'
```

### ✅ 正确模式（执行实际查询）
```
用户：查看2024年1月的财务数据
AI：让我查询2024年1月的财务数据。

**查询结果：**
| 月份 | 收入 | 支出 | 利润 |
|---|---|---|---|
| 2024-01 | 150000 | 120000 | 30000 |

根据查询结果...
```

## 5. 常见问题及解决方案

### 问题1：AI不调用queryDataset函数
**原因：** LLM提供商不支持工具调用
**解决：** 切换到OpenAI或其他支持工具调用的提供商

### 问题2：工具调用失败
**原因：** 数据集配置错误或数据库连接问题
**解决：** 检查数据集配置和数据库连接状态

### 问题3：SQL语法错误
**原因：** AI生成的SQL与实际表结构不匹配
**解决：** 确保数据集字段信息准确，或在架构信息中提供更详细的描述

### 问题4：权限不足
**原因：** 用户对数据集没有查询权限
**解决：** 检查用户权限配置，确认有数据集访问权限

## 6. 调试技巧

### 开发者工具检查
1. 打开浏览器开发者工具
2. 查看Network标签页
3. 找到对话API请求
4. 检查请求和响应内容

### 后端日志查看
```bash
# 查看Next.js开发服务器日志
npm run dev

# 关注以下日志信息：
# - [Dataset Chat] 数据集: xxx
# - 🔧 [Dataset Chat] 使用配置: xxx
# - ✅ [Dataset Chat] AI响应成功
# - ❌ [Dataset Chat] LLM调用失败
```

### API测试
使用Postman或curl直接测试dataset-chat API：
```bash
curl -X POST http://localhost:3000/api/ai/dataset-chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "datasetId": "your_dataset_id",
    "message": "查看前5条数据",
    "includeSchema": true
  }'
```

## 7. 性能优化建议

### 减少上下文长度
- 设置适当的`previewLimit`（建议10-20行）
- 限制历史对话长度（建议8-10条）
- 对于大型数据集，考虑不包含预览数据

### 查询优化
- 使用具体的字段名而不是`SELECT *`
- 添加合适的LIMIT限制
- 对于聚合查询，使用GROUP BY和合适的索引

## 8. 最佳实践

### 用户提问建议
鼓励用户使用明确的查询描述：
- ✅ "显示2024年1月的销售数据"
- ✅ "查看收入最高的5个产品"
- ✅ "统计各地区的订单数量"
- ❌ "分析一下数据"（太模糊）

### 数据集配置建议
- 提供清晰的字段描述和数据类型
- 在预览数据中包含有代表性的样本
- 定期更新数据集统计信息

### LLM配置建议
- 使用支持工具调用的最新模型版本
- 设置合适的temperature（建议0.3-0.7）
- 配置足够的max_tokens（建议1000-2000）

## 9. 故障恢复步骤

### 快速修复流程
1. **检查LLM配置**：确认使用支持工具调用的提供商
2. **验证数据集状态**：确认数据集配置正确且可访问
3. **测试简单查询**：先尝试"显示前5条数据"等简单请求
4. **逐步增加复杂度**：从简单查询开始，逐步测试复杂场景

### 重启服务
```bash
# 停止开发服务器
Ctrl+C

# 清理缓存并重启
rm -rf .next/cache
npm run dev
```

## 10. 联系支持

如果问题仍未解决，请提供以下信息：
- 当前使用的LLM提供商和模型
- 具体的用户提问内容
- AI的完整响应
- 浏览器开发者工具中的网络请求日志
- 服务器端错误日志

---

通过以上排查步骤，应该能够解决大部分AI不执行数据查询的问题。关键是确保使用支持工具调用的LLM提供商，并正确配置数据集和数据库连接。