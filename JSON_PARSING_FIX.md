# LLMå·¥å…·è°ƒç”¨JSONè§£æžé”™è¯¯ä¿®å¤

## ðŸ” é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ°çš„é”™è¯¯ï¼š
```
æŸ¥è¯¢æ‰§è¡Œå¤±è´¥
é”™è¯¯ä¿¡æ¯ï¼š Unexpected token 'å¥½', "å¥½çš„ï¼Œç”¨æˆ·éœ€è¦æŸ¥è¯¢2"... is not valid JSON
```

**æ ¹æœ¬åŽŸå› ï¼š** LLMåœ¨å·¥å…·è°ƒç”¨æ—¶è¿”å›žäº†åŒ…å«ä¸­æ–‡è§£é‡Šçš„éžæ ‡å‡†JSONæ ¼å¼ï¼Œå¯¼è‡´`JSON.parse()`å¤±è´¥ã€‚

## ðŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. é—®é¢˜åˆ†æž
LLMå¯èƒ½è¿”å›žå¦‚ä¸‹æ ¼å¼çš„å·¥å…·è°ƒç”¨å‚æ•°ï¼š
```javascript
// âŒ é”™è¯¯æ ¼å¼
"å¥½çš„ï¼Œç”¨æˆ·éœ€è¦æŸ¥è¯¢2024å¹´1æœˆçš„æ•°æ® {\"sql\": \"SELECT * FROM table WHERE date = '2024-01'\", \"limit\": 10} è¿™æ˜¯æŸ¥è¯¢è¯­å¥"

// âœ… æ­£ç¡®æ ¼å¼  
"{\"sql\": \"SELECT * FROM table WHERE date = '2024-01'\", \"limit\": 10}"
```

### 2. æŠ€æœ¯ä¿®å¤

#### **å¥å£®çš„JSONè§£æžå‡½æ•°**
åˆ›å»ºäº†`parseToolArguments()`å‡½æ•°ï¼Œé‡‡ç”¨å¤šå±‚å®¹é”™ç­–ç•¥ï¼š

```javascript
function parseToolArguments(argumentsString: string): { sql: string; limit?: number } {
  // 1. å°è¯•ç›´æŽ¥JSONè§£æž
  try {
    const parsed = JSON.parse(argumentsString)
    if (parsed.sql) return parsed
  } catch { /* ç»§ç»­ä¸‹ä¸€æ­¥ */ }
  
  // 2. æ¸…ç†JSONè¾¹ç•Œï¼Œç§»é™¤å‰åŽæ— å…³å†…å®¹
  const jsonStart = cleaned.indexOf('{')
  const jsonEnd = cleaned.lastIndexOf('}')
  if (jsonStart !== -1 && jsonEnd !== -1) {
    cleaned = cleaned.substring(jsonStart, jsonEnd + 1)
    // é‡è¯•è§£æž
  }
  
  // 3. æ­£åˆ™è¡¨è¾¾å¼æå–SQLå’Œlimit
  const sqlMatch = argumentsString.match(/"sql":\s*"([^"]+)"/i)
  const limitMatch = argumentsString.match(/"limit":\s*(\d+)/i)
  
  // 4. æœ€åŽå¤‡é€‰ï¼šç›´æŽ¥è¯†åˆ«SQLè¯­å¥
  if (trimmed.toLowerCase().startsWith('select')) {
    sql = trimmed
  }
}
```

#### **æ”¹è¿›çš„ç³»ç»Ÿæç¤º**
æ·»åŠ äº†æ˜Žç¡®çš„JSONæ ¼å¼è¦æ±‚ï¼š
```
âš ï¸ å·¥å…·è°ƒç”¨æ ¼å¼è¦æ±‚ï¼š
- å‚æ•°å¿…é¡»æ˜¯æ ‡å‡†JSONæ ¼å¼ï¼š{"sql": "SELECT ...", "limit": 20}
- sqlå­—æ®µåªåŒ…å«SQLè¯­å¥ï¼Œä¸è¦æ·»åŠ è§£é‡Šæ–‡å­—
- ä¸è¦åœ¨JSONå¤–æ·»åŠ ä»»ä½•ä¸­æ–‡è¯´æ˜Žæˆ–è§£é‡Š
```

#### **å·¥å…·å‡½æ•°æè¿°ä¼˜åŒ–**
```javascript
{
  name: "queryDataset",
  description: "æŸ¥è¯¢æ•°æ®é›†ä¸­çš„çœŸå®žæ•°æ®ã€‚å¿…é¡»è¿”å›žæ ‡å‡†JSONæ ¼å¼çš„å‚æ•°ã€‚",
  parameters: {
    properties: {
      sql: {
        description: "è¦æ‰§è¡Œçš„SQLæŸ¥è¯¢è¯­å¥ï¼ˆä»…æ”¯æŒSELECTè¯­å¥ï¼Œä¸è¦åŒ…å«è§£é‡Šæ–‡å­—ï¼‰"
      }
    },
    additionalProperties: false  // ä¸¥æ ¼é™åˆ¶é¢å¤–å±žæ€§
  }
}
```

### 3. å®¹é”™æœºåˆ¶

#### **å¤šç§æ ¼å¼æ”¯æŒ**
- æ ‡å‡†JSON: `{"sql": "SELECT ...", "limit": 20}`
- å¸¦å¼•å·æ··ç”¨: `{'sql': 'SELECT ...', "limit": 20}`
- å¸¦åå¼•å·: `{"sql": \`SELECT ...\`, "limit": 20}`
- çº¯SQLè¯†åˆ«: ç›´æŽ¥è¯†åˆ«ä»¥SELECTå¼€å¤´çš„è¯­å¥

#### **é”™è¯¯æ¢å¤**
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- é€æ­¥é™çº§çš„è§£æžç­–ç•¥
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 4. è°ƒè¯•å¢žå¼º

#### **è¯¦ç»†æ—¥å¿—**
```javascript
console.log('[Dataset Chat] å·¥å…·è°ƒç”¨å‚æ•°åŽŸå§‹å†…å®¹:', toolCall.function.arguments)
console.log('[Dataset Chat] æå–çš„å‚æ•°:', { sql, limit })
```

#### **é”™è¯¯è¿½è¸ª**
- è®°å½•åŽŸå§‹å‚æ•°å†…å®¹
- è®°å½•æ¯ä¸€æ­¥è§£æžå°è¯•
- æä¾›å…·ä½“çš„å¤±è´¥åŽŸå› 

## ðŸš€ ä½¿ç”¨æ•ˆæžœ

### ä¿®å¤å‰
```
âŒ é”™è¯¯ï¼šUnexpected token 'å¥½', "å¥½çš„ï¼Œç”¨æˆ·éœ€è¦æŸ¥è¯¢2"... is not valid JSON
```

### ä¿®å¤åŽ
```javascript
// çŽ°åœ¨å¯ä»¥æ­£ç¡®å¤„ç†å„ç§æ ¼å¼ï¼š

// æ ¼å¼1ï¼šæ ‡å‡†JSON
{"sql": "SELECT * FROM finance_data WHERE date >= '2024-01-01' AND date < '2024-02-01'", "limit": 10}

// æ ¼å¼2ï¼šå¸¦ä¸­æ–‡è§£é‡Šï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
"å¥½çš„ï¼Œæˆ‘æ¥æŸ¥è¯¢2024å¹´1æœˆçš„æ•°æ® {\"sql\": \"SELECT * FROM finance_data WHERE date >= '2024-01-01'\", \"limit\": 10}"

// æ ¼å¼3ï¼šçº¯SQLè¯­å¥ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
"SELECT * FROM finance_data WHERE date >= '2024-01-01' AND date < '2024-02-01' LIMIT 10"

âœ… ç»“æžœï¼šæˆåŠŸè§£æžå¹¶æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿”å›žå®žé™…æ•°æ®è¡¨æ ¼
```

## ðŸ›¡ï¸ å®‰å…¨ä¿éšœ

### SQLå®‰å…¨æ£€æŸ¥
- ä»ç„¶ä¿æŒåŽŸæœ‰çš„SQLæ³¨å…¥é˜²æŠ¤
- ä»…å…è®¸SELECTæŸ¥è¯¢è¯­å¥
- è‡ªåŠ¨æ·»åŠ LIMITé™åˆ¶

### å‚æ•°éªŒè¯
- ç¡®ä¿sqlå‚æ•°ä¸ä¸ºç©º
- éªŒè¯limitèŒƒå›´ï¼ˆ1-100ï¼‰
- ç±»åž‹æ£€æŸ¥å’Œè½¬æ¢

## ðŸ“Š æ€§èƒ½å½±å“

### è§£æžæ€§èƒ½
- å¤šå±‚è§£æžç­–ç•¥å¯èƒ½ç•¥å¢žåŠ å¤„ç†æ—¶é—´ï¼ˆ< 5msï¼‰
- ä½†å¤§å¹…æé«˜äº†æˆåŠŸçŽ‡å’Œç”¨æˆ·ä½“éªŒ
- é¿å…äº†ç”¨æˆ·éœ€è¦é‡å¤å°è¯•çš„æƒ…å†µ

### æ—¥å¿—å¼€é”€
- å¢žåŠ äº†è°ƒè¯•æ—¥å¿—è¾“å‡º
- ç”Ÿäº§çŽ¯å¢ƒå¯æ ¹æ®éœ€è¦è°ƒæ•´æ—¥å¿—çº§åˆ«

## ðŸŽ¯ æœ€ä½³å®žè·µå»ºè®®

### å¯¹äºŽå¼€å‘è€…
1. **ç›‘æŽ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥å·¥å…·è°ƒç”¨å¤±è´¥çš„æƒ…å†µ
2. **æ¨¡åž‹é€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨JSONæ ¼å¼æ›´è§„èŒƒçš„LLMæ¨¡åž‹
3. **å‚æ•°éªŒè¯**ï¼šåœ¨å·¥å…·å‡½æ•°ä¸­å§‹ç»ˆè¿›è¡Œå‚æ•°éªŒè¯

### å¯¹äºŽç”¨æˆ·
1. **æ¸…æ™°æé—®**ï¼šä½¿ç”¨æ˜Žç¡®çš„æŸ¥è¯¢æ„å›¾ï¼ˆ"æ˜¾ç¤ºå‰10æ¡æ•°æ®"ï¼‰
2. **è€å¿ƒç­‰å¾…**ï¼šå¤æ‚æŸ¥è¯¢å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´å¤„ç†
3. **åé¦ˆé”™è¯¯**ï¼šå¦‚é‡é—®é¢˜è¯·æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

## ðŸ”® æœªæ¥ä¼˜åŒ–

1. **æ™ºèƒ½JSONä¿®å¤**ï¼šåŸºäºŽAIçš„JSONæ ¼å¼è‡ªåŠ¨ä¿®å¤
2. **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒå‚æ•°ç¡®è®¤å’Œä¿®æ­£çš„å¯¹è¯æµ
3. **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜æˆåŠŸè§£æžçš„å‚æ•°æ¨¡å¼
4. **A/Bæµ‹è¯•**ï¼šä¸åŒç³»ç»Ÿæç¤ºçš„æ•ˆæžœå¯¹æ¯”

---

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼ŒAIæ•°æ®æŸ¥è¯¢åŠŸèƒ½çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒå¾—åˆ°äº†æ˜¾è‘—æå‡ï¼ŒçŽ°åœ¨å¯ä»¥å¤„ç†å„ç§LLMè¿”å›žçš„éžæ ‡å‡†æ ¼å¼ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿå¯é åœ°èŽ·å–çœŸå®žæ•°æ®ã€‚