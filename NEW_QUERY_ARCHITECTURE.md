# ğŸš€ æ–°æ•°æ®é›†æŸ¥è¯¢æ¶æ„å®ç°å®Œæˆ

## ğŸ¯ æ¶æ„æ¦‚è¿°

æˆåŠŸå®ç°äº†ç”¨æˆ·è¦æ±‚çš„**è‡ªç„¶è¯­è¨€ â†’ æ„å›¾æå– â†’ DSL â†’ SQL**çš„æ–°æŸ¥è¯¢æ¶æ„ï¼Œæ›¿ä»£äº†åŸæœ‰çš„ç›´æ¥å·¥å…·è°ƒç”¨æ–¹å¼ã€‚

## ğŸ“‹ å®ç°æ­¥éª¤

### âœ… 1. è®¾è®¡è‡ªç„¶è¯­è¨€è§£ææ¶æ„

åˆ›å»ºäº†å®Œæ•´çš„ç±»å‹å®šä¹‰ç³»ç»Ÿï¼š

**æ–‡ä»¶ï¼š** `src/types/query-intent.ts`

```typescript
// æ ¸å¿ƒæ¥å£å®šä¹‰
export interface QueryIntent {
  timeRange?: TimeRange        // æ—¶é—´èŒƒå›´
  metrics: Metric[]           // æŒ‡æ ‡å­—æ®µ
  dimensions: Dimension[]     // ç»´åº¦å­—æ®µ  
  filters: Filter[]          // è¿‡æ»¤æ¡ä»¶
  limit?: number             // ç»“æœé™åˆ¶
  orderBy?: { field: string; direction: 'asc' | 'desc' }
  description: string        // åŸå§‹æŸ¥è¯¢æè¿°
}

export interface QueryDSL {
  select: Array<{ field: string; aggregation?: string; alias?: string }>
  from: string
  where?: Array<{ field: string; operator: string; value: unknown }>
  groupBy?: string[]
  orderBy?: Array<{ field: string; direction: 'asc' | 'desc' }>
  limit?: number
  timeRange?: { field: string; start?: string | number; end?: string | number }
}
```

### âœ… 2. å®ç°ç”¨æˆ·æ„å›¾æå–çš„LLMè°ƒç”¨

åˆ›å»ºäº†æ™ºèƒ½æ„å›¾æå–æœåŠ¡ï¼š

**æ–‡ä»¶ï¼š** `src/lib/intent-extraction.ts`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ğŸ“ æ„å»ºä¸“ä¸šçš„LLMç³»ç»Ÿæç¤ºï¼ŒæŒ‡å¯¼æ„å›¾æå–
- ğŸ”§ æ”¯æŒå¤šç§LLMæä¾›å•†ï¼ˆOpenAIã€æ™ºè°±AIã€æœˆä¹‹æš—é¢ã€DeepSeekï¼‰
- âœ… å¥å£®çš„JSONè§£æå’Œé”™è¯¯æ¢å¤æœºåˆ¶
- ğŸ¯ æ™ºèƒ½æ„å›¾éªŒè¯å’Œå»ºè®®ç”Ÿæˆ

**å…³é”®ç‰¹æ€§ï¼š**
```typescript
// æ„å›¾æå–ä¸»å‡½æ•°
export async function extractQueryIntent(
  request: IntentExtractionRequest, 
  llmConfig?: { provider: string; config: any }
): Promise<IntentExtractionResponse>

// æ„å›¾éªŒè¯å‡½æ•°
export function validateQueryIntent(intent: QueryIntent): { valid: boolean; errors: string[] }
```

### âœ… 3. åˆ›å»ºDSLåˆ°SQLçš„è½¬æ¢å¼•æ“

å®ç°äº†å®Œæ•´çš„DSLè½¬æ¢ç³»ç»Ÿï¼š

**æ–‡ä»¶ï¼š** `src/lib/dsl-to-sql.ts`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ğŸ”„ æ„å›¾è½¬DSLï¼š`intentToDSL()`
- ğŸ”¨ DSLè½¬SQLï¼š`dslToSQL()` 
- ğŸš€ å®Œæ•´æµç¨‹ï¼š`intentToSQL()`

**è½¬æ¢èƒ½åŠ›ï¼š**
- âœ… æ—¶é—´èŒƒå›´å¤„ç†ï¼ˆç»å¯¹æ—¶é—´ã€ç›¸å¯¹æ—¶é—´ã€å‘¨æœŸæ€§ï¼‰
- âœ… æŒ‡æ ‡èšåˆï¼ˆSUMã€COUNTã€AVGã€MAXã€MINã€DISTINCT_COUNTï¼‰
- âœ… ç»´åº¦åˆ†ç»„å’Œæ’åº
- âœ… å¤æ‚è¿‡æ»¤æ¡ä»¶ï¼ˆ=ã€!=ã€>ã€<ã€INã€LIKEã€BETWEENç­‰ï¼‰
- âœ… SQLå®‰å…¨è½¬ä¹‰å’Œæ³¨å…¥é˜²æŠ¤

### âœ… 4. é‡æ„dataset-chat APIæ”¯æŒæ–°æ¶æ„

å®Œå…¨é‡æ„äº†APIå¤„ç†æµç¨‹ï¼š

**æ–‡ä»¶ï¼š** `src/app/api/ai/dataset-chat/route.ts`

**æ–°å¤„ç†æµç¨‹ï¼š**
1. ğŸ“¥ æ¥æ”¶ç”¨æˆ·è‡ªç„¶è¯­è¨€æŸ¥è¯¢
2. ğŸ§  è°ƒç”¨LLMæå–ç»“æ„åŒ–æ„å›¾
3. ğŸ”§ éªŒè¯æ„å›¾å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§
4. ğŸ”¨ ç”ŸæˆDSLå¹¶è½¬æ¢ä¸ºSQL
5. ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
6. ğŸ“Š æ ¼å¼åŒ–ç»“æœä¸ºMarkdownè¡¨æ ¼
7. ğŸ’¡ æä¾›æŸ¥è¯¢åˆ†æå’Œä¼˜åŒ–å»ºè®®

**å“åº”æ ¼å¼å¢å¼ºï¼š**
```json
{
  "message": "åŒ…å«æŸ¥è¯¢åˆ†æã€ç»“æœè¡¨æ ¼ã€ç»Ÿè®¡ä¿¡æ¯å’Œå»ºè®®çš„Markdownå†…å®¹",
  "queryInfo": {
    "sql": "ç”Ÿæˆçš„SQLè¯­å¥",
    "dsl": "ä¸­é—´DSLç»“æ„",
    "intent": "æå–çš„æŸ¥è¯¢æ„å›¾",
    "confidence": 0.95,
    "recordsReturned": 25
  }
}
```

### âœ… 5. æµ‹è¯•å’Œä¼˜åŒ–æŸ¥è¯¢å‡†ç¡®æ€§

å®ç°äº†å¤šå±‚ä¼˜åŒ–æœºåˆ¶ï¼š

**æ„å›¾æå–ä¼˜åŒ–ï¼š**
- ğŸ¯ ä¸“ä¸šåŒ–ç³»ç»Ÿæç¤ºï¼ŒåŒ…å«è¯¦ç»†çš„å­—æ®µæ˜ å°„ç¤ºä¾‹
- ğŸ” å¤šé‡éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿æå–æ„å›¾çš„å®Œæ•´æ€§
- ğŸ’¡ æ™ºèƒ½å»ºè®®ç”Ÿæˆï¼Œå¸®åŠ©ç”¨æˆ·æ”¹è¿›æŸ¥è¯¢

**DSLè½¬æ¢ä¼˜åŒ–ï¼š**
- ğŸ›¡ï¸ å®Œå–„çš„SQLå®‰å…¨æ£€æŸ¥å’Œè½¬ä¹‰
- ğŸ“Š æ™ºèƒ½å­—æ®µåå¤„ç†ï¼ˆä¸­æ–‡æ˜¾ç¤ºå â†’ è‹±æ–‡å­—æ®µåï¼‰
- âš¡ è‡ªåŠ¨åŒ–LIMITé™åˆ¶å’Œæ€§èƒ½ä¼˜åŒ–

**é”™è¯¯å¤„ç†ä¼˜åŒ–ï¼š**
- ğŸ“ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ğŸ¯ å…·ä½“çš„ç”¨æˆ·é”™è¯¯æŒ‡å¯¼
- ğŸ”„ å¤šå±‚å®¹é”™å’Œé™çº§ç­–ç•¥

## ğŸ”¥ æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½æ„å›¾ç†è§£
- ğŸ§  åˆ©ç”¨LLMçš„è‡ªç„¶è¯­è¨€ç†è§£èƒ½åŠ›
- ğŸ¯ è‡ªåŠ¨è¯†åˆ«æ—¶é—´èŒƒå›´ã€æŒ‡æ ‡ã€ç»´åº¦ã€è¿‡æ»¤æ¡ä»¶
- ğŸ“Š æ”¯æŒä¸­æ–‡æŸ¥è¯¢ï¼Œè‡ªåŠ¨æ˜ å°„åˆ°è‹±æ–‡æ•°æ®åº“å­—æ®µ

### 2. ç»“æ„åŒ–æŸ¥è¯¢æ„å»º
- ğŸ“ æ ‡å‡†åŒ–çš„DSLä¸­é—´è¡¨ç¤º
- ğŸ”§ æ¨¡å—åŒ–çš„è½¬æ¢å¼•æ“è®¾è®¡
- ğŸ›¡ï¸ å®Œå–„çš„SQLæ³¨å…¥é˜²æŠ¤

### 3. ç”¨æˆ·ä½“éªŒæå‡
- ğŸ“ˆ ç½®ä¿¡åº¦è¯„åˆ†ï¼Œè®©ç”¨æˆ·äº†è§£æŸ¥è¯¢ç†è§£å‡†ç¡®æ€§
- ğŸ’¡ æ™ºèƒ½å»ºè®®ï¼Œå¸®åŠ©ä¼˜åŒ–æŸ¥è¯¢è¡¨è¾¾
- ğŸ“Š ä¸°å¯Œçš„ç»“æœå±•ç¤ºï¼ŒåŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œæ‰§è¡Œè¯¦æƒ…

### 4. ç³»ç»Ÿç¨³å®šæ€§
- ğŸ”„ å¤šå±‚å®¹é”™æœºåˆ¶
- ğŸ“ å®Œæ•´çš„é”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
- âš¡ æ€§èƒ½ä¼˜åŒ–å’ŒæŸ¥è¯¢é™åˆ¶

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·è¾“å…¥ï¼š
```
"æ˜¾ç¤º2024å¹´1æœˆå„éƒ¨é—¨çš„è¥æ”¶æƒ…å†µï¼ŒæŒ‰è¥æ”¶ä»é«˜åˆ°ä½æ’åº"
```

### ç³»ç»Ÿå¤„ç†æµç¨‹ï¼š
1. **æ„å›¾æå–** â†’ æ—¶é—´èŒƒå›´ï¼š2024å¹´1æœˆï¼ŒæŒ‡æ ‡ï¼šè¥æ”¶ï¼ˆSUMï¼‰ï¼Œç»´åº¦ï¼šéƒ¨é—¨ï¼Œæ’åºï¼šDESC
2. **DSLç”Ÿæˆ** â†’ ç»“æ„åŒ–æŸ¥è¯¢è¡¨ç¤º
3. **SQLè½¬æ¢** â†’ `SELECT department, SUM(revenue_amount) AS æ€»è¥æ”¶ FROM finance_data WHERE date_field = '202401' GROUP BY department ORDER BY æ€»è¥æ”¶ DESC LIMIT 100`
4. **æŸ¥è¯¢æ‰§è¡Œ** â†’ è¿”å›å®é™…æ•°æ®
5. **ç»“æœå±•ç¤º** â†’ Markdownè¡¨æ ¼ + åˆ†æè¯´æ˜

### è¿”å›ç»“æœï¼š
```markdown
**æŸ¥è¯¢åˆ†æ** (ç½®ä¿¡åº¦: 95%)
æˆåŠŸè¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼šæŒ‰æ—¶é—´ç­›é€‰2024å¹´1æœˆæ•°æ®ï¼Œç»Ÿè®¡å„éƒ¨é—¨è¥æ”¶æ€»å’Œï¼ŒæŒ‰é‡‘é¢é™åºæ’åˆ—ã€‚

**æŸ¥è¯¢ç»“æœ**
| éƒ¨é—¨ | æ€»è¥æ”¶ |
|---|---|
| é”€å”®éƒ¨ | 1,250,000.00 |
| å¸‚åœºéƒ¨ | 980,000.00 |
| æŠ€æœ¯éƒ¨ | 750,000.00 |

**ç»Ÿè®¡ä¿¡æ¯ï¼š**
- æŸ¥è¯¢è¿”å›ï¼š3 æ¡è®°å½•
- åŒ…å«æŒ‡æ ‡ï¼šæ€»è¥æ”¶
- æŒ‰ç»´åº¦åˆ†ç»„ï¼šéƒ¨é—¨

**ä¼˜åŒ–å»ºè®®**
â€¢ å¯ä»¥è¿›ä¸€æ­¥æŒ‰äº§å“çº¿ç»†åˆ†åˆ†æ
â€¢ å»ºè®®å¯¹æ¯”å»å¹´åŒæœŸæ•°æ®
```

## ğŸ› ï¸ éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒè¦æ±‚ï¼š** ç¡®ä¿LLM APIé…ç½®æ­£ç¡®ï¼ˆOpenAI/æ™ºè°±AIç­‰ï¼‰
2. **æ•°æ®åº“è¿æ¥ï¼š** éªŒè¯æ•°æ®é›†æŸ¥è¯¢APIæ­£å¸¸è¿è¡Œ
3. **æƒé™æ£€æŸ¥ï¼š** ç¡®è®¤ç”¨æˆ·æœ‰æ•°æ®é›†è®¿é—®æƒé™
4. **æ€§èƒ½ç›‘æ§ï¼š** å…³æ³¨LLMè°ƒç”¨å»¶è¿Ÿå’ŒæŸ¥è¯¢æ‰§è¡Œæ—¶é—´

## ğŸ¯ æœªæ¥æ‰©å±•æ–¹å‘

1. **ç¼“å­˜æœºåˆ¶ï¼š** ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢æ„å›¾å’ŒSQLæ¨¡æ¿
2. **A/Bæµ‹è¯•ï¼š** ä¸åŒç³»ç»Ÿæç¤ºçš„æ•ˆæœå¯¹æ¯”
3. **ç”¨æˆ·åé¦ˆï¼š** æ”¶é›†æŸ¥è¯¢ç»“æœæ»¡æ„åº¦ï¼ŒæŒç»­ä¼˜åŒ–
4. **å¯è§†åŒ–å»ºè®®ï¼š** åŸºäºæŸ¥è¯¢ç»“æœæ¨èåˆé€‚çš„å›¾è¡¨ç±»å‹

---

âœ… **æ–°æ•°æ®é›†æŸ¥è¯¢æ¶æ„å·²å®Œå…¨å®ç°ï¼Œå¯æ”¯æŒæ™ºèƒ½çš„è‡ªç„¶è¯­è¨€æ•°æ®æŸ¥è¯¢åŠŸèƒ½ï¼**